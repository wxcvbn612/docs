{"pageContext":{"html":"<h1 id=\"performance-and-cache\"><a href=\"#performance-and-cache\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance and Cache</h1>\n<h2 id=\"enabling-the-built-in-http-cache-invalidation-system\"><a href=\"#enabling-the-built-in-http-cache-invalidation-system\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enabling the Built-in HTTP Cache Invalidation System</h2>\n<p>Exposing a hypermedia API has <a href=\"http://blog.theamazingrando.com/in-band-vs-out-of-band.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">many advantages</a>. One of\nthem is the ability to know exactly which resources are included in HTTP responses created by the API. We used this\nspecificity to make API Platform apps blazing fast.</p>\n<p>When the cache mechanism <a href=\"/docs/core/configuration/\">is enabled</a>, API Platform collects identifiers of every resources\nincluded in a given HTTP response (including lists, embedded documents and subresources) and returns them in a special\nHTTP header called <a href=\"https://support.cloudflare.com/hc/en-us/articles/206596608-How-to-Purge-Cache-Using-Cache-Tags-Enterprise-only-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Cache-Tags</a>.</p>\n<p>A <a href=\"https://en.wikipedia.org/wiki/Web_accelerator\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cache reverse proxy</a> supporting cache tags (Varnish, CloudFlare,\nFastly…) must be put in front of the web server and store all responses returned by the API with a high\n<a href=\"https://en.wikipedia.org/wiki/Time_to_live\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">TTL</a>. When a resource is modified, API Platform takes care of purging all\nresponses containing it in the proxy’s cache. It means that after the first request, all subsequent requests will not\ntouch the web server, and will be served instantly from the cache. It also means that the content served will always be\nfresh, because the cache is purged in real time.</p>\n<p>The support for most specific cases such as the invalidation of collections when a document is added or removed or for\nrelationships and inverse relations is built-in.</p>\n<p>Integration with Varnish and Doctrine ORM is shipped with the core library, and <a href=\"https://varnish-cache.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Varnish</a> is included in the <a href=\"/docs/distribution/index/#using-the-official-distribution-recommended\">Docker setup</a> provided with the\ndistribution of API Platform.\nIf you use the distribution, this feature works out of the box.</p>\n<p>If you don't, add the following configuration to enable the cache invalidation system:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Adds a fallback VARNISH_URL if the env var is not set.</span>\n    <span class=\"token comment\"># This allows you to run cache:warmup even if your</span>\n    <span class=\"token comment\"># environment variables are not available yet.</span>\n    <span class=\"token comment\"># You should not need to change this value.</span>\n    <span class=\"token key atrule\">env(VARNISH_URL)</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span>\n\n<span class=\"token key atrule\">api_platform</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ...</span>\n    <span class=\"token key atrule\">http_cache</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">invalidation</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n            <span class=\"token key atrule\">varnish_urls</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'%env(VARNISH_URL)%'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token comment\"># Adds sensitive default cache headers</span>\n        <span class=\"token key atrule\">max_age</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n        <span class=\"token key atrule\">shared_max_age</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3600</span>\n        <span class=\"token key atrule\">vary</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Authorization'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">public</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>Support for reverse proxies other than Varnish can easily be added by implementing the <code class=\"language-text\">ApiPlatform\\Core\\HttpCache\\PurgerInterface</code>.</p>\n<p>In addition to the cache invalidation mechanism, you may want to <a href=\"/docs/core/push-relations/\">use HTTP/2 Server Push to pre-emptively send relations to the client</a>.</p>\n<h3 id=\"extending-cache-tags-for-invalidation\"><a href=\"#extending-cache-tags-for-invalidation\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Extending Cache-Tags for invalidation</h3>\n<p>Sometimes you need individual resources like <code class=\"language-text\">/me</code>. To work properly with Varnish, the cache tags need to be augmented with these resources. Here is an example how this can be done:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">declare</span><span class=\"token punctuation\">(</span>strict_types<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>EventSubscriber</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>EventListener<span class=\"token punctuation\">\\</span>EventPriorities</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Entity<span class=\"token punctuation\">\\</span>User</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Symfony<span class=\"token punctuation\">\\</span>Component<span class=\"token punctuation\">\\</span>EventDispatcher<span class=\"token punctuation\">\\</span>EventSubscriberInterface</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Symfony<span class=\"token punctuation\">\\</span>Component<span class=\"token punctuation\">\\</span>HttpKernel<span class=\"token punctuation\">\\</span>Event<span class=\"token punctuation\">\\</span>GetResponseEvent</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Symfony<span class=\"token punctuation\">\\</span>Component<span class=\"token punctuation\">\\</span>HttpKernel<span class=\"token punctuation\">\\</span>KernelEvents</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserResourcesSubscriber</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EventSubscriberInterface</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSubscribedEvents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n            KernelEvents<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">REQUEST</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'extendResources'</span><span class=\"token punctuation\">,</span> EventPriorities<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">POST_READ</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">extendResources</span><span class=\"token punctuation\">(</span>GetResponseEvent <span class=\"token variable\">$event</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$request</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$class</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">attributes</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_api_resource_class'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$class</span> <span class=\"token operator\">===</span> User<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$resources</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token single-quoted-string string\">'/me'</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">attributes</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_resources'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">attributes</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_resources'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">)</span><span class=\"token variable\">$resources</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<h2 id=\"setting-custom-http-cache-headers\"><a href=\"#setting-custom-http-cache-headers\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setting Custom HTTP Cache Headers</h2>\n<p>The <code class=\"language-text\">cache_headers</code> attribute can be used to set custom HTTP cache headers:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource(cacheHeaders={\"max_age\"=60, \"shared_max_age\"=120})\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For all endpoints related to this resource class, the following HTTP header will be set:</p>\n<p><code class=\"language-text\">Cache-Control: max-age=60, public, s-maxage=120</code></p>\n<p>It's also possible to set different cache headers per operation:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource(\n *     itemOperations={\n *         \"get\"={\"cache_headers\"={\"max_age\"=60, \"shared_max_age\"=120}}\n *     }\n * )\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"enabling-the-metadata-cache\"><a href=\"#enabling-the-metadata-cache\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enabling the Metadata Cache</h2>\n<p>Computing metadata used by the bundle is a costly operation. Fortunately, metadata can be computed once and then cached.\nAPI Platform internally uses a <a href=\"http://www.php-fig.org/psr/psr-6/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PSR-6</a> cache. If the Symfony Cache Component is available\n(the default in the official distribution), it automatically enables the support for the best cache adapter available.</p>\n<p>Best performance is achieved using <a href=\"https://github.com/krakjoe/apcu\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">APCu</a>. Be sure to have the APCu extension installed\non your production server, API Platform will automatically use it.</p>\n<p>This parameter can be changed by changing the value of <code class=\"language-text\">api_platform.metadata_cache</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># api/config/config.yaml</span>\n\n<span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enable the metadata cache to speedup the builds</span>\n    <span class=\"token key atrule\">api_platform.metadata_cache</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<h2 id=\"using-ppm-php-pm\"><a href=\"#using-ppm-php-pm\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using PPM (PHP-PM)</h2>\n<p>Response time of the API can be improved up to 15x by using <a href=\"https://github.com/php-pm/php-pm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PHP Process Manager</a>. If\nyou want to use it on your project, follow the documentation dedicated to Symfony on the PPM website.</p>\n<p>Keep in mind that PPM is still in an early stage of development and can cause issues in production.</p>\n<h2 id=\"doctrine-queries-and-indexes\"><a href=\"#doctrine-queries-and-indexes\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Doctrine Queries and Indexes</h2>\n<h3 id=\"search-filter\"><a href=\"#search-filter\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Search Filter</h3>\n<p>When using the <code class=\"language-text\">SearchFilter</code> and case insensivity, Doctrine will use the <code class=\"language-text\">LOWER</code> SQL function. Depending on your\ndriver, you may want to carefully index it by using a <a href=\"http://use-the-index-luke.com/sql/where-clause/functions/case-insensitive-search\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">function-based\nindex</a> or it will impact performance\nwith a huge collection. <a href=\"http://use-the-index-luke.com/sql/where-clause/searching-for-ranges/like-performance-tuning\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Here are some examples to index LIKE\nfilters</a> depending on your\ndatabase driver.</p>\n<h3 id=\"eager-loading\"><a href=\"#eager-loading\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Eager Loading</h3>\n<p>By default Doctrine comes with <a href=\"http://doctrine-orm.readthedocs.io/en/latest/reference/working-with-objects.html#by-lazy-loading\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">lazy loading</a>.\nUsually a killer time-saving feature and also a performance killer with large applications.</p>\n<p>Fortunately, Doctrine proposes another approach to remedy this problem: <a href=\"http://doctrine-orm.readthedocs.io/en/latest/reference/working-with-objects.html#by-eager-loading\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">eager loading</a>.\nThis can easily be enabled for a relation: <code class=\"language-text\">@ORM\\ManyToOne(fetch=&quot;EAGER&quot;)</code>.</p>\n<p>By default in API Platform, we made the choice to force eager loading for all relations, with or without the Doctrine\n<code class=\"language-text\">fetch</code> attribute. Thanks to the eager loading <a href=\"/docs/core/extensions/\">extension</a>. The <code class=\"language-text\">EagerLoadingExtension</code> will join every\nreadable association according to the serialization context. If you want to fetch an association that is not serializable\nyou've to bypass <code class=\"language-text\">readable</code> and <code class=\"language-text\">readableLink</code> by using the <code class=\"language-text\">fetchEager</code> attribute on the property declaration, for example:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token comment\">/**\n * @ApiProperty(attributes={\"fetchEager\": true})\n */</span>\n <span class=\"token keyword\">public</span> <span class=\"token variable\">$foo</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4 id=\"max-joins\"><a href=\"#max-joins\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Max Joins</h4>\n<p>There is a default restriction with this feature. We allow up to 30 joins per query. Beyond, an\n<code class=\"language-text\">ApiPlatform\\Core\\Exception\\RuntimeException</code> exception will be thrown but this value can easily be increased with a\nlittle of configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># api/config/packages/api_platform.yaml</span>\n<span class=\"token key atrule\">api_platform</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">eager_loading</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">max_joins</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span></code></pre></div>\n<p>Be careful when you exceed this limit, it's often caused by the result of a circular reference. <a href=\"/docs/core/serialization/\">Serializer groups</a>\ncan be a good solution to fix this issue.</p>\n<h4 id=\"force-eager\"><a href=\"#force-eager\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Force Eager</h4>\n<p>As mentioned above, by default we force eager loading for all relations. This behaviour can be modified with the\nconfiguration in order to apply it only on join relations having the <code class=\"language-text\">EAGER</code> fetch mode:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># api/config/packages/api_platform.yaml</span>\n<span class=\"token key atrule\">api_platform</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">eager_loading</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">force_eager</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></code></pre></div>\n<h4 id=\"override-at-resource-and-operation-level\"><a href=\"#override-at-resource-and-operation-level\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Override at Resource and Operation Level</h4>\n<p>When eager loading is enabled, whatever the status of the <code class=\"language-text\">force_eager</code> parameter, you can easily override it directly\nfrom the configuration of each resource. You can do this at the resource level, at the operations level, or both:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// api/src/Entity/Address.php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Entity</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Doctrine<span class=\"token punctuation\">\\</span>ORM<span class=\"token punctuation\">\\</span>Mapping</span> <span class=\"token keyword\">as</span> <span class=\"token constant\">ORM</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource\n * @ORM\\Entity\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Address</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// api/src/Entity/User.php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Entity</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Doctrine<span class=\"token punctuation\">\\</span>ORM<span class=\"token punctuation\">\\</span>Mapping</span> <span class=\"token keyword\">as</span> <span class=\"token constant\">ORM</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource(attributes={\"force_eager\"=false})\n * @ORM\\Entity\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * @var Address\n     *\n     * @ORM\\ManyToOne(targetEntity=\"Address\", fetch=\"EAGER\")\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$address</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * @var Group[]\n     *\n     * @ORM\\ManyToMany(targetEntity=\"Group\", inversedBy=\"users\")\n     * @ORM\\JoinTable(name=\"users_groups\")\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$groups</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// api/src/Entity/Group.php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Entity</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Doctrine<span class=\"token punctuation\">\\</span>ORM<span class=\"token punctuation\">\\</span>Mapping</span> <span class=\"token keyword\">as</span> <span class=\"token constant\">ORM</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource(\n *     attributes={\"force_eager\"=false},\n *     itemOperations={\n *         \"get\"={\"force_eager\"=true},\n *         \"post\"\n *     },\n *     collectionOperations={\n *         \"get\"={\"force_eager\"=true},\n *         \"post\"\n *     }\n * )\n * @ORM\\Entity\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Group</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * @var User[]\n     *\n     * @ManyToMany(targetEntity=\"User\", mappedBy=\"groups\")\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$users</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Be careful, the operation level is higher priority than the resource level but both are higher priority than the global\nconfiguration.</p>\n<h4 id=\"disable-eager-loading\"><a href=\"#disable-eager-loading\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disable Eager Loading</h4>\n<p>If for any reason you don't want the eager loading feature, you can turn it off in the configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># api/config/packages/api_platform.yaml</span>\n<span class=\"token key atrule\">api_platform</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">eager_loading</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></code></pre></div>\n<p>The whole configuration seen before will no longer work and Doctrine will recover its default behavior.</p>\n<h3 id=\"partial-pagination\"><a href=\"#partial-pagination\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Partial Pagination</h3>\n<p>When using the default pagination, the Doctrine paginator will execute a <code class=\"language-text\">COUNT</code> query on the collection. The result of the\n<code class=\"language-text\">COUNT</code> query is used to compute the latest page available. With big collections this can lead to quite long response times.\nIf you don't mind not having the latest page available, you can enable partial pagination and avoid the <code class=\"language-text\">COUNT</code> query:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># api/config/packages/api_platform.yaml</span>\n<span class=\"token key atrule\">api_platform</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">collection</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">pagination</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">partial</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true </span><span class=\"token comment\"># Disabled by default</span></code></pre></div>\n<p>More details are available on the <a href=\"/docs/core/pagination/#partial-pagination\">pagination documentation</a>.</p>\n<h2 id=\"profiling-with-blackfireio\"><a href=\"#profiling-with-blackfireio\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Profiling with Blackfire.io</h2>\n<p>Blackfire.io allows you to monitor the performance of your applications. For more information, visit the <a href=\"https://blackfire.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Blackfire.io website</a>.</p>\n<p>To configure Blackfire.io follow these simple steps:</p>\n<ol>\n<li>Add the following to your <code class=\"language-text\">docker-compose.yml</code> file (or an <a href=\"https://docs.docker.com/compose/reference/overview/#specifying-multiple-compose-files\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">override file</a>, if only to be used in development)</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">        <span class=\"token key atrule\">blackfire</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> blackfire/blackfire\n          <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n              <span class=\"token comment\"># Exposes the host BLACKFIRE_SERVER_ID and TOKEN environment variables.</span>\n              <span class=\"token punctuation\">-</span> BLACKFIRE_SERVER_ID\n              <span class=\"token punctuation\">-</span> BLACKFIRE_SERVER_TOKEN</code></pre></div>\n<ol start=\"2\">\n<li>\n<p>Add your Blackfire.io id and server token to your <code class=\"language-text\">.env</code> file at the root of your project (be sure not to commit this to a public repository)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">BLACKFIRE_SERVER_ID=xxxxxxxxxx\nBLACKFIRE_SERVER_TOKEN=xxxxxxxxxx</code></pre></div>\n<p>or set it in the console before running Docker commands</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ export BLACKFIRE_SERVER_ID=xxxxxxxxxx\n$ export BLACKFIRE_SERVER_TOKEN=xxxxxxxxxx</code></pre></div>\n</li>\n<li>\n<p>Install and configure the Blackfire probe in the app container, by adding the following to your <code class=\"language-text\">./Dockerfile</code></p>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\">        RUN version=$(php -r &quot;echo PHP_MAJOR_VERSION.PHP_MINOR_VERSION;&quot;) \\\n            &amp;&amp; curl -A &quot;Docker&quot; -o /tmp/blackfire-probe.tar.gz -D - -L -s https://blackfire.io/api/v1/releases/probe/php/alpine/amd64/$version \\\n            &amp;&amp; tar zxpf /tmp/blackfire-probe.tar.gz -C /tmp \\\n            &amp;&amp; mv /tmp/blackfire-*.so $(php -r &quot;echo ini_get(&#39;extension_dir&#39;);&quot;)/blackfire.so \\\n            &amp;&amp; printf &quot;extension=blackfire.so\\nblackfire.agent_socket=tcp://blackfire:8707\\n&quot; &gt; $PHP_INI_DIR/conf.d/blackfire.ini</code></pre></div>\n<ol start=\"4\">\n<li>\n<p>Rebuild and restart all your containers</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ docker-compose build\n$ docker-compose up -d</code></pre></div>\n</li>\n</ol>\n<p>For details on how to perform profiling, see <a href=\"https://blackfire.io/docs/integrations/docker#using-the-client-for-http-profiling\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the Blackfire.io documentation</a>.</p>","editPath":"core/performance.md","title":"Performance and Cache","previous":{"slug":"/docs/core/deprecations/","title":"Deprecating Resources and Properties (Alternative to Versioning)"},"next":{"slug":"/docs/core/extensions/","title":"Extensions"}}}