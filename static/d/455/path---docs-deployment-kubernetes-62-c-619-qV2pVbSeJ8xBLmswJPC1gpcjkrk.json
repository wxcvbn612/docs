{"pageContext":{"html":"<h1 id=\"deploying-to-a-kubernetes-cluster\"><a href=\"#deploying-to-a-kubernetes-cluster\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploying to a Kubernetes Cluster</h1>\n<p><a href=\"https://kubernetes.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Kubernetes</a> has become the most popular way to deploy, run and manage containers in production.\nBoth <a href=\"https://cloud.google.com/kubernetes-engine/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Cloud Platform</a>, <a href=\"https://azure.microsoft.com/en-us/services/container-service/kubernetes/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Microsoft Azure</a>\nand <a href=\"https://aws.amazon.com/eks/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Amazon Web Services</a> provide managed Kubernetes environment.</p>\n<p><a href=\"/docs/distribution/index/\">The official API Platform distribution</a> contains a built-in <a href=\"https://helm.sh/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Helm</a> (the k8s\npackage manager) chart to deploy in a wink on any of these platforms.</p>\n<h2 id=\"preparing-your-cluster-and-your-local-machine\"><a href=\"#preparing-your-cluster-and-your-local-machine\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Preparing Your Cluster and Your Local Machine</h2>\n<ol>\n<li>Create a Kubernetes cluster on your preferred Cloud provider or install Kubernetes locally on your servers</li>\n<li>Install <a href=\"https://helm.sh/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Helm</a> locally and on your cluster following their documentation</li>\n<li>Be sure to be connected to the right Kubernetes container e.g. running: <code class=\"language-text\">gcloud config get-value core/project</code></li>\n<li>Update the Helm repo: <code class=\"language-text\">helm repo update</code></li>\n</ol>\n<h2 id=\"creating-and-publishing-the-docker-images\"><a href=\"#creating-and-publishing-the-docker-images\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating and Publishing the Docker Images</h2>\n<ol>\n<li>\n<p>Build the PHP and Nginx Docker images:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker build -t gcr.io/test-api-platform/php -t gcr.io/test-api-platform/php:latest api --target api_platform_php\ndocker build -t gcr.io/test-api-platform/nginx -t gcr.io/test-api-platform/nginx:latest api --target api_platform_nginx\ndocker build -t gcr.io/test-api-platform/varnish -t gcr.io/test-api-platform/varnish:latest api --target api_platform_varnish</code></pre></div>\n</li>\n<li>\n<p>Push your images to your Docker registry, example with <a href=\"https://cloud.google.com/container-registry/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Container Registry</a>:</p>\n<p>Docker client versions &#x3C;= 18.03:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">gcloud docker -- push gcr.io/test-api-platform/php\ngcloud docker -- push gcr.io/test-api-platform/nginx\ngcloud docker -- push gcr.io/test-api-platform/varnish</code></pre></div>\n<p>Docker client versions > 18.03:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">gcloud auth configure-docker\ndocker push gcr.io/test-api-platform/php\ndocker push gcr.io/test-api-platform/nginx\ndocker push gcr.io/test-api-platform/varnish</code></pre></div>\n</li>\n</ol>\n<h2 id=\"deploying\"><a href=\"#deploying\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploying</h2>\n<p>Firstly you need to update helm dependencies by running:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm dependency update ./api/helm/api</code></pre></div>\n<p>You are now ready to deploy the API!</p>\n<p>Deploy your API to the container:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm install ./api/helm/api --namespace=baz --name baz \\\n    --set php.repository=gcr.io/test-api-platform/php \\\n    --set nginx.repository=gcr.io/test-api-platform/nginx \\\n    --set secret=MyAppSecretKey \\\n    --set postgresql.postgresPassword=MyPgPassword \\\n    --set postgresql.persistence.enabled=true \\\n    --set corsAllowOrigin=&#39;^https?://[a-z\\]*\\.mywebsite.com$&#39;</code></pre></div>\n<p>If you prefer to use a managed DBMS like <a href=\"https://www.heroku.com/postgres\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Heroku Postgres</a> or\n<a href=\"https://cloud.google.com/sql/docs/postgres/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Cloud SQL</a> (recommended):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm install --name api ./api/helm/api \\\n    # ...\n    --set postgresql.enabled=false \\\n    --set postgresql.url=pgsql://username:password@host/database?serverVersion=9.6</code></pre></div>\n<p>If you want to use a managed Varnish such as <a href=\"https://www.fastly.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Fastly</a> for the invalidation cache mechanism\nprovided by API Platform:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm install --name api ./api/helm/api \\\n    # ...\n    --set varnish.enabled=false \\\n    --set varnish.url=https://myvarnish.com</code></pre></div>\n<p>Finally, build the <code class=\"language-text\">client</code> and <code class=\"language-text\">admin</code> JavaScript apps and <a href=\"https://github.com/facebookincubator/create-react-app/blob/master/packages/react-scripts/template/README.md#deployment\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">deploy them on a static\nwebsite hosting service</a>.</p>\n<h2 id=\"initializing-the-database\"><a href=\"#initializing-the-database\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Initializing the Database</h2>\n<p>Before running your application for the first time, be sure to create the database schema:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PHP_POD=$(kubectl --namespace=bar get pods -l app=php -o jsonpath=&quot;{.items[0].metadata.name}&quot;)\nkubectl --namespace=bar exec -it $PHP_POD -- bin/console doctrine:schema:create</code></pre></div>\n<h2 id=\"tiller-rbac-issue\"><a href=\"#tiller-rbac-issue\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tiller RBAC Issue</h2>\n<p>We noticed that some tiller RBAC trouble occurred, you generally can resolve it running:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl create serviceaccount --namespace kube-system tiller\n  serviceaccount &quot;tiller&quot; created\n\nkubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller\n  clusterrolebinding &quot;tiller-cluster-rule&quot; created\n\nkubectl patch deploy --namespace kube-system tiller-deploy -p &#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;serviceAccount&quot;:&quot;tiller&quot;}}}}&#39;\n  deployment &quot;tiller-deploy&quot; patched</code></pre></div>\n<p>Please, see the <a href=\"https://github.com/kubernetes/helm/issues/3130\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">related issue</a> for further details / informations\nYou can also take a look to the <a href=\"https://github.com/kubernetes/helm/blob/master/docs/rbac.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">related documentation</a></p>","editPath":"deployment/kubernetes.md","title":"Deploying to a Kubernetes Cluster","previous":{"slug":"/docs/deployment/","title":"Deploying API Platform Applications"},"next":{"slug":"/docs/deployment/heroku/","title":"Deploying an API Platform App on Heroku"}}}