{"pageContext":{"html":"<h1 id=\"pushing-live-updates-using-the-mercure-protocol\"><a href=\"#pushing-live-updates-using-the-mercure-protocol\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pushing Live Updates Using the Mercure Protocol</h1>\n<p>API Platform can automatically send real time updates to the currently connected clients (webapps, mobile apps...) using <a href=\"https://mercure.rocks\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the Mercure protocol</a>.</p>\n<blockquote>\n<p><em>Mercure</em> is a protocol allowing to push data updates to web browsers and other HTTP clients in a convenient, fast, reliable and battery-efficient way. It is especially useful to publish real-time updates of resources served through web APIs, to reactive web and mobile apps.</p>\n<ul>\n<li><a href=\"https://mercure.rocks\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://mercure.rocks</a></li>\n</ul>\n</blockquote>\n<p>API Platform detects changes made to your Doctrine entities, and sends the updated resources to the Mercure hub.\nThen, the Mercure hub dispatches the updates to all connected clients using <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Server-sent Events (SSE)</a>.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/13b4b3f12cee8fe2894e9a34f02fc4ad/5cd76/mercure-subscriptions.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 1120px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 69.20609462710505%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAADt0lEQVQ4y01Ue0yTVxQ/9/u+loIyRJE5CSyMKQMjcTr2x1jmNAxpQLPM6JBkwQDRGenilGwtLbSUFYQC7aC8WlIesRRhSgtSwdpSQdpRGGUPYFTmZJOZmbCETJI9stx9360QTnJz7z339/vdc859AC4DiHbdRsBa42h23FVnnk3uyPUk9moTOV+mXYkAY4CKNgRVnQjs3wDcvAfQNwpg4doYOx4L9Fx72TlAcURwTaXlO6T/Fg/l4EyrAcdoeps590FzHwNF9TTBsML5/XJa7/2EzpwwI7g+gXhW1yZhtof73zEE7JkrgOkf8f7OwbUM0xSOrbZqgP+S4IUrmjAQVQmYXGl8gqQwHJ7b4e5KWjGjosG4jEL6HWgjQvB8TwTpqbkLMPUA7+twrsXUD2OQdLQzpy5GQZExeBQPUZBdEgaHjLE2X96rS4snjq0LX5mspOHaz5sEJ2YD6UwvZMHcLxjqbBgKjTOg6Erh3EJnG2+d7P76uMh++8gT38QxjP867fj9YSqpc+E4G+ktd6C2zF0vQNMQyjUVI3T/29OgG7iU9LaERJ18rUFASvfPyfjHfuGC25WKF2cz8NOHaXh1MWX+6WzyQW7dtCymoNUaODCoNlD2nwZp2Gx/riJoGuC/O95FhB89SIt89uhw27Pf0v9b8b+zvDafdI49LsLZViDdDRerycZQbtwkoqw8Ga1rr4GiBSa6u5+B4Ukamm280E9LI9kYCXnlh9cPjdnfeIXgH2M6d1rHg/PKKMiRJqEbIwgMFnZBVJIg7DR2t/u8OMtkneawf2BMIfc8DZ9rt0B+aUx8WzNfaFKFEKEPauL3yiS7MHc3n9suaZmAMXxFwcflCPKvW1bHlvz4Q8sIhqImLQfYIanfArJGAZQZgghjZIaCPHlcbHFx+NH+Oh5036XZO4lC1c1HX2uvTSaY1Avb0FlpBKR23MBx5h4MUnXTmVUcfWLYcxyyxQlcBNRNFw1yAz+sTs+LqGgRJI7co4Nae0hd+V/ozu6UaXGCTI4P1Co0INO9BRkitpaqljLQ95SLfQtG85MVXOCdnQdF44scibozQ/ELFKGQpdq9kV+Dm4rk0hUpQnZKSrMjLquWwmXqv+kvjWkbmEs+v63K/yvOcXqV8N5HWzlfeK+DEo63kjf+puLcvnS19Or7DboD3DxYe4vaINe2bIeagR3ccKtGH/BHGfv2Q0n9nnWMwMR+FlYPpDSIiaDOgoLTKz7rylRfnlQPppDnd6RFTG1X1jLrnCC9mYj9D5fCgSGV1hneAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Mercure subscriptions\"\n        title=\"\"\n        src=\"/static/13b4b3f12cee8fe2894e9a34f02fc4ad/f066b/mercure-subscriptions.png\"\n        srcset=\"/static/13b4b3f12cee8fe2894e9a34f02fc4ad/324c3/mercure-subscriptions.png 280w,\n/static/13b4b3f12cee8fe2894e9a34f02fc4ad/53f37/mercure-subscriptions.png 560w,\n/static/13b4b3f12cee8fe2894e9a34f02fc4ad/f066b/mercure-subscriptions.png 1120w,\n/static/13b4b3f12cee8fe2894e9a34f02fc4ad/5cd76/mercure-subscriptions.png 1247w\"\n        sizes=\"(max-width: 1120px) 100vw, 1120px\"\n      />\n  </span>\n  </a></p>\n<h2 id=\"installing-the-mercure-support\"><a href=\"#installing-the-mercure-support\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Installing the Mercure Support</h2>\n<p>The Mercure support is already installed, configured and enabled in <a href=\"/docs/distribution/index/\">the official distribution</a>.\nIf you use the distribution, you have nothing more to do, and you can jump to the next section.</p>\n<p>If you have installed API Platform using another method (such as <code class=\"language-text\">composer require api</code>), you need to install a Mercure hub, and the <a href=\"https://github.com/symfony/mercure-bundle\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Symfony MercureBundle</a>:</p>\n<p>First, <a href=\"https://github.com/dunglas/mercure#hub-implementation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">download and run a Mercure hub</a>.\nThen, install the Symfony bundle:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> $ composer require mercure</code></pre></div>\n<p>Finally, 3 environment variables <a href=\"https://symfony.com/doc/current/configuration/external_parameters.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">must be set</a>:</p>\n<ul>\n<li><code class=\"language-text\">MERCURE_PUBLISH_URL</code>: the URL that must be used by API Platform to publish updates to your Mercure hub (can be an internal or a public URL)</li>\n<li><code class=\"language-text\">MERCURE_SUBSCRIBE_URL</code>: the <strong>public</strong> URL of the Mercure hub that clients will use to subscribe to updates</li>\n<li><code class=\"language-text\">MERCURE_JWT</code>: a valid Mercure <a href=\"https://jwt.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">JSON Web Token (JWT)</a> allowing API Platform to publish updates to the hub</li>\n</ul>\n<p>The JWT <strong>must</strong> contain a <code class=\"language-text\">mercure.publish</code> property containing an array of targets.\nThis array can be empty to allow publishing anonymous updates only.\n<a href=\"https://jwt.io/#debugger-io?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJtZXJjdXJlIjp7InN1YnNjcmliZSI6WyJmb28iLCJiYXIiXSwicHVibGlzaCI6WyJmb28iXX19.LRLvirgONK13JgacQ_VbcjySbVhkSmHy3IznH3tA9PM\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Example publisher JWT</a> (demo key: <code class=\"language-text\">!UnsecureChangeMe!</code>).</p>\n<p><a href=\"https://github.com/dunglas/mercure/blob/master/spec/mercure.md#authorization\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Learn more about Mercure authorization.</a></p>\n<h2 id=\"pushing-the-api-updates\"><a href=\"#pushing-the-api-updates\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pushing the API Updates</h2>\n<p>Use the <code class=\"language-text\">mercure</code> attribute to hint API Platform that it must dispatch the updates regarding the given resources to the Mercure hub:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// api/src/Entity/Book.php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Entity</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource(mercure=true)\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Then, every time an object of this type is created, updated or deleted, the new version is sent to all connected clients through the Mercure hub.\nIf the resource has been deleted, only the (now deleted) IRI of the resource is sent to the clients.</p>\n<p>In addition, API Platform automatically adds a <code class=\"language-text\">Link</code> HTTP header to all responses related to this resource class.\nThis header allows smart clients to automatically discover the Mercure hub.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b9ed0a62e3a7458862d332d1ab891d5/6eb37/mercure-discovery.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 1120px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 49.79859013091641%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACU0lEQVQoz2NgAIJ1xy8zMmABJZtn8i7cl9rRuaXwoc/0SfYgsdRlLUxGzUsYcIKtZ2+ADfv//7/wu3dvgz68e+v34s2baCBfJPjw4eLyI0v+Zyxb+T9kyqY2kLqcxVuY9arm4zYQqBFMFy3enTt314nr83adOLPkwJkbnUt3NzrtOz/TZ/fV/9GzD/13bl/ZCFLXuekY64V7D5muP37KdOPJM6Zrj54w3Xr2gunWk6dMZx4+YQIbZly7QE8mf5ox1A6498PO38jwXH/on37VvIvyjYsdGYgF+pVLNLnTFopgk3NeuldJb9EO6abTV4Kev3xlcuLOA6vTd+5bnLn30OIsEJ+6fc/iwsMnFqdu3rHYf/OeBViTYmm3Y+DkBW0MqSvATnZqX8xg17eWwaRnJcS13D7su249eAoMnv8/fv36/+vX7/9//v79/+/fv/9//vz5DwMf/wLDL2PBkrwF+/d+L1u68SksTO3nrGd0WbWXwXPrUUiYTForMvPs1Z5XL18233r0pOXWg0ctd588bXn44mXLg+cvW+4/e97y9devlnvvP7UwtO08+D97+dr/4uWTQTHLjM3bARsPicnP36ZLVPiZdsyYE7Z848Kdj14ebDlyYS13z2LJgC1Hpd3W7pdyXbtf0m3dATEgbeKz4aAlSP2mi9dZPz1+wPzj5TPmv+9eM/95+4r5NxCDHPPv1y9mhoSdZ2Umn7l+Z/KxC22Oi7aYuq874Oi2br810BBLIDYDYlsgtgIazAkyMGTLEYZFV+6i4IVAvOTqPYYZF28xAAB2TUza9yRWHgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Mercure subscriptions\"\n        title=\"\"\n        src=\"/static/3b9ed0a62e3a7458862d332d1ab891d5/f066b/mercure-discovery.png\"\n        srcset=\"/static/3b9ed0a62e3a7458862d332d1ab891d5/324c3/mercure-discovery.png 280w,\n/static/3b9ed0a62e3a7458862d332d1ab891d5/53f37/mercure-discovery.png 560w,\n/static/3b9ed0a62e3a7458862d332d1ab891d5/f066b/mercure-discovery.png 1120w,\n/static/3b9ed0a62e3a7458862d332d1ab891d5/354a5/mercure-discovery.png 1680w,\n/static/3b9ed0a62e3a7458862d332d1ab891d5/6eb37/mercure-discovery.png 1986w\"\n        sizes=\"(max-width: 1120px) 100vw, 1120px\"\n      />\n  </span>\n  </a></p>\n<p>Clients generated using <a href=\"/docs/client-generator/index/\">the API Platform Client Generator</a> will use this capability to automatically subscribe to Mercure updates when available:</p>\n<p><img src=\"/client-generator-demo-d20c0f7f49b5655a3788d9c570c1c80a.gif\" alt=\"Screencast\"></p>\n<p><a href=\"https://github.com/dunglas/mercure#examples\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Learn how to use the discovery capabilities of Mercure in your own clients</a>.</p>\n<h2 id=\"dispatching-private-updates-authorized-mode\"><a href=\"#dispatching-private-updates-authorized-mode\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dispatching Private Updates (Authorized Mode)</h2>\n<p>Mercure allows to dispatch <a href=\"https://github.com/dunglas/mercure/blob/master/spec/mercure.md#authorization\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">private updates, that will be received only by authorized clients</a>.\nTo receive this kind of updates, the client must hold a JWT containing at least one <em>target</em> marking the update.</p>\n<p>Then, hint API Platform to dispatch the updates only to the selected targets:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// api/src/Entity/Book.php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Entity</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource(mercure={\"a-group\", \"another-group\"})\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>It's also possible to execute an <em>expression</em> (using the <a href=\"https://symfony.com/doc/current/components/expression_language.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Symfony Expression Language component</a>), to generate a dynamic list of targets:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// api/src/Entity/Book.php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Entity</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource(mercure=\"object.owners\")\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$owners</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n   <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>","editPath":"core/mercure.md","title":"Pushing Live Updates Using the Mercure Protocol","previous":{"slug":"/docs/core/data-persisters/","title":"Data Persisters"},"next":{"slug":"/docs/core/mongodb/","title":"MongoDB Support"}}}